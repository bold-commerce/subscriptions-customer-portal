.publish:
  stage: publish
  dependencies: []

.docker:
  extends: .publish
  image: $DOCKER_IMAGE
  variables:
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker login ${DOCKER_REGISTRY:-$CI_REGISTRY}
      -u ${DOCKER_REGISTRY_USER:-$CI_REGISTRY_USER}
      -p ${DOCKER_REGISTRY_PASSWORD:-$CI_REGISTRY_PASSWORD}

.preview:
  extends: .docker
  only:
    refs:
      - branches
  except:
    refs:
      - tags
  dependencies:
    - npm preview
  needs:
    - npm preview

.release:
  extends: .docker
  only:
    refs:
      - tags
  except:
    - branches
  dependencies:
    - npm release
  needs:
    - npm release

outside front preview:
  extends: .preview
  script:
    - docker build
      --build-arg NODE_IMAGE=$NODE_IMAGE
      --build-arg NGINX_IMAGE=$NGINX_IMAGE
      --build-arg BASIC_USER=$BASIC_USER
      --build-arg BASIC_PASS=$BASIC_PASS
      --build-arg DIST_DIR=$DIST_DIR
      --build-arg APP_ENV=development
      -t $IMAGE_TAG -f .docker/Dockerfile .
    - docker push $IMAGE_TAG

outside front release:
  extends: .release
  script:
    - docker build -f .docker/Dockerfile .
      --build-arg NODE_IMAGE=$NODE_IMAGE
      --build-arg NGINX_IMAGE=$NGINX_IMAGE
      --build-arg DIST_DIR=$DIST_DIR
      --build-arg APP_ENV=production
      --tag $IMAGE_TAG
      --tag $CI_REGISTRY_IMAGE:latest
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
